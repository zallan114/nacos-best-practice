# 网关端口（前端统一访问8888端口）
server:
  port: 8800

spring:
  application:
    name: nacos-gateway # 网关服务名
  config:
    import-check:
      enabled: false  # 禁止Nacos配置导入检查（关键）
  cloud:
    # Nacos 服务发现配置（和其他服务一致）
    nacos:
      discovery:
        #enabled: false # 临时禁用Nacos服务发现
        server-addr: localhost:8848
        namespace: dev
        group: DEFAULT_GROUP
        username: nacos # Nacos 3.1.1+ 需要配置用户名（默认：nacos）
        password: ${NACOS_PASSWORD:nacos} # Nacos 3.1.1+ 需要配置密码（使用环境变量，默认值：nacos）
        # 连接池配置（默认有默认值，显式配置更稳定）
        # max-http-connection-pool-size: 200  # 最大HTTP连接池大小
        # keep-alive: true  # 开启HTTP长连接
        # heart-beat-interval: 5000  # 心跳间隔（ms）
        # heart-beat-timeout: 60000  # 心跳超时（ms）
        # ip-delete-timeout: 120000  # 服务端删除IP超时（ms）
        # connect-timeout: 10000  # 连接超时（ms）
        # export NACOS_PASSWORD=your_secure_password
    # Gateway 核心配置
    gateway:
      filters:
        - AddRequestHeader=Content-Type, application/json;charset=UTF-8
        - AddRequestHeader=Accept-Charset, UTF-8
      # 路由规则配置（核心）

      # 各个模块自己做高并发请求数量控制
      routes:
        # 路由1：转发到消费者服务（nacos-consumer）
        - id: consumer_route # 路由ID（唯一）
          uri: lb://nacos-consumer # lb:// + 服务名（负载均衡转发）
          predicates:
            - Path=/consumer/** # 匹配路径：/consumer/** 的请求转发到消费者
          filters:
            - StripPrefix=0 # 不剥离路径前缀（/consumer/user/1 完整转发）
            - AddResponseHeader=X-Response-Default-Foo, Default-Bar # 可选：添加响应头

        # 路由2：转发到提供者服务（nacos-provider）
        - id: provider_route
          uri: lb://nacos-provider
          predicates:
            - Path=/provider/** # 匹配路径：/provider/** 的请求转发到提供者
          filters:
            - StripPrefix=0

        # 路由3：转发到配置中心示例（nacos-config-demo）
        - id: config_route
          uri: lb://nacos-config-demo
          predicates:
            - Path=/config-demo/** # 匹配路径：/config-demo/** 的请求转发到配置示例
          filters:
            - StripPrefix=0

      # 跨域配置（解决前端跨域问题）
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*" # 允许所有源（生产环境指定具体域名）
            allowedMethods: "*" # 允许所有请求方法（GET/POST/PUT/DELETE等）
            allowedHeaders: "*" # 允许所有请求头
            allowCredentials: true # 允许携带Cookie
            maxAge: 3600 # 预检请求缓存时间（秒）

    # LoadBalancer 配置（网关负载均衡）
    loadbalancer:
      cache:
        ttl: 0 # 关闭缓存，实时感知服务实例变化

# 暴露网关端点（便于监控）
management:
  endpoints:
    web:
      exposure:
        include: 'gateway,routes,health'
  endpoint:
    gateway:
      enabled: true # 开启网关端点
    health:
      show-details: always

# 日志配置
logging:
  file:
    path: /tmp/
    name: /tmp/nacos-gateway.log
  level:
    root: INFO
    com.example: DEBUG