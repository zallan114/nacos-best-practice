# 服务器端口（消费者固定8801，避免和提供者/配置示例冲突）
server:
  port: 8801

# Spring 核心配置
spring:
  # 应用名称（Nacos注册的服务名，必须唯一）
  application:
    name: nacos-consumer
  # 配置导入（解决Nacos启动检查）
  config:
    import-check:
      enabled: false  # 禁止Nacos配置导入检查（关键）
  # 云原生相关配置（Nacos/负载均衡）
  cloud:
    # Nacos 服务注册发现配置
    nacos:
      discovery:
        # Nacos Server 地址（本地单机版）
        server-addr: localhost:8848
        # 命名空间（必须和提供者/配置中心一致，dev命名空间）
        namespace: dev
        # 分组（默认即可，需和提供者一致）
        group: DEFAULT_GROUP
        # 元数据（可选，用于灰度发布/路由）
        metadata:
          version: v1
          env: dev
        # Nacos 3.1.1+ 需要配置用户名和密码
        username: nacos
        password: ${NACOS_PASSWORD:nacos} # 使用环境变量，默认值：nacos
    # LoadBalancer 负载均衡配置（核心：实时感知提供者实例）
    loadbalancer:
      # 关闭负载均衡缓存（开发环境便于测试多实例切换）
      cache:
        ttl: 0
      # 负载均衡策略（默认轮询，可选随机：RandomLoadBalancer）
      # 如需自定义策略，可添加此配置
      # configuration:
      #   default:
      #     algorithm: org.springframework.cloud.loadbalancer.core.RandomLoadBalancer

    sentinel:
      transport:
        dashboard: localhost:8888 # Sentinel控制台地址（需单独启动）
        port: 8719 # 客户端与控制台通信端口
      eager: true # 饥饿加载，避免首次请求触发限流
    datasource:
      # 自定义数据源名称（可任意）
      flow-rule:
        file:
          # 规则文件路径（classpath 下的 sentinel-flow-rules.json）
          file: 'classpath:sentinel-flow-rules.json'
          # 数据格式（JSON/YAML）
          data-type: json
          # 规则类型（flow=限流，degrade=熔断，etc.）
          rule-type: flow
          #  - 为byOrderStatus资源设置QPS限流阈值为20
          #  - 为/api/products/**路径设置QPS限流阈值为100
      # 熔断降级规则配置
      degrade-rule:
        file:
          file: 'classpath:sentinel-degrade-rules.json'
          data-type: json
          rule-type: degrade
          #  grade : 熔断策略（0: 基于RT，1: 基于异常比例，2: 基于异常数）
          #  - RT模式：响应时间阈值（毫秒）
          #  - 异常比例模式：异常比例阈值（0-1之间）
          #  - 异常数模式：异常数量阈值
          #- 对byOrderStatus资源：当响应时间超过200ms时熔断，熔断10秒
          #- 对/api/orders/**路径：当异常比例超过50%时熔断，熔断15秒
          #- 对/api/payments/**路径：当异常数超过5个时熔断，熔断20秒

# Feign 配置（服务调用核心）
feign:
  # 客户端全局配置
  client:
    config:
      # 默认配置（对所有Feign客户端生效）
      default:
        # 连接超时时间（5秒）
        connectTimeout: 5000
        # 读取超时时间（5秒）
        readTimeout: 5000
  # 开启HttpClient（提升Feign性能）
  httpclient:
    enabled: true
  # 日志级别（开发环境可开启，便于调试）
  logger:
    level:
      # 对提供者Feign客户端开启DEBUG日志
      com.example.consumer.feign.ProviderFeignClient: DEBUG

# 线程池自定义配置（支持Nacos/Spring Cloud Config动态刷新）
thread:
  pool:
    # CPU密集型线程池（如计算、排序）
    cpu:
      core-size: ${CPU_CORE:${random.int[2,4]}} # 默认2-4核，可通过环境变量覆盖
      max-size: ${CPU_MAX:${random.int[4,8]}} # CPU核心数×2
      keep-alive-seconds: 60
      queue-size: 1000
      pool-name: cpu-task-pool
    # IO密集型线程池（如HTTP请求、数据库操作）
    io:
      core-size: ${IO_CORE:${random.int[8,16]}} # CPU核心数×2+1
      max-size: ${IO_MAX:${random.int[20,40]}} # CPU核心数×10
      keep-alive-seconds: 30
      queue-size: 500
      pool-name: io-task-pool

# 监控端点配置（Nacos健康检查/监控）
management:
  endpoints:
    web:
      exposure:
        # 暴露所有端点（健康检查、配置刷新等）
        include: '*'
  endpoint:
    health:
      # 显示健康检查详情
      show-details: always

# 日志配置
logging:
  file:
    path: /tmp/
    name: /tmp/nacos-consumer.log
  level:
    # Spring Cloud 负载均衡日志（调试实例选择）
    org.springframework.cloud.loadbalancer: DEBUG
    # Nacos 注册发现日志
    com.alibaba.cloud.nacos: INFO
    root: INFO
    com.example: DEBUG